<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance Asset Tracker</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!-- Alpine.js for interactivity -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Crypto-JS for HMAC SHA256 signature -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-[#0f111a] text-slate-300 min-h-screen font-sans selection:bg-amber-500/30">
    <div x-data="binanceApp()" class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 pb-6 border-b border-white/5">
            <h1 class="text-4xl font-black tracking-tight text-white mb-4 md:mb-0 drop-shadow-lg">
                <span class="bg-gradient-to-r from-amber-400 to-yellow-600 bg-clip-text text-transparent">Binance</span>
                <span class="font-light text-slate-400">Tracker</span>
            </h1>
            <div class="flex gap-4">
                <button @click="showSettings = !showSettings" class="px-5 py-2.5 bg-slate-800/50 hover:bg-slate-800 hover:text-white text-slate-400 rounded-xl transition-all duration-300 border border-white/5 hover:border-white/10 shadow-lg backdrop-blur-sm flex items-center gap-2 text-sm font-medium">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.532 1.532 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                    </svg>
                    Settings
                </button>
                <button @click="fetchData()" :disabled="loading" class="px-6 py-2.5 bg-gradient-to-r from-amber-500 to-yellow-600 hover:from-amber-400 hover:to-yellow-500 text-black font-bold rounded-xl shadow-lg shadow-amber-900/20 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 transform active:scale-95">
                    <svg x-show="loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-black" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span x-text="loading ? 'Syncing...' : 'Refresh'"></span>
                </button>
            </div>
        </header>

        <!-- API Settings Section -->
        <div x-show="showSettings || !hasKeys" x-transition class="mb-8 p-8 bg-slate-900 rounded-3xl border border-white/10 shadow-2xl relative">
            <button x-show="hasKeys" @click="showSettings = false" class="absolute top-6 right-6 text-slate-500 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <h2 class="text-2xl font-bold mb-6 text-white tracking-tight">Binance API Configuration</h2>
            
            <div class="mb-6 p-5 bg-blue-500/10 border border-blue-500/20 rounded-2xl text-blue-200 text-sm flex items-start gap-4">
                <div class="bg-blue-500/20 p-2 rounded-lg shrink-0 text-blue-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div>
                    <p class="font-bold mb-1 text-blue-100">Local & Secure</p>
                    <p class="leading-relaxed">Your keys are stored only in your browser's <code class="bg-blue-900/50 px-1 py-0.5 rounded text-xs">localStorage</code> and used to sign requests locally. They are never sent to any backend server.</p>
                </div>
            </div>

            <div class="mb-8 p-5 bg-amber-500/10 border border-amber-500/20 rounded-2xl text-amber-200 text-sm flex items-start gap-4">
                 <div class="bg-amber-500/20 p-2 rounded-lg shrink-0 text-amber-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <div>
                    <p class="font-bold mb-1 text-amber-100">CORS Requirement</p>
                    <p class="leading-relaxed mt-1">Binance API blocks direct browser requests. To fetch real data, you <strong>must</strong> enable a browser extension like <em>"Allow CORS: Access-Control-Allow-Origin"</em>.</p>
                </div>
            </div>
            
            <div class="grid md:grid-cols-2 gap-6 mb-8">
                <div>
                    <label class="block text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">API Key</label>
                    <input type="text" x-model="apiKey" class="w-full bg-slate-950 border border-white/10 rounded-xl px-5 py-3 text-white focus:border-amber-500 focus:ring-1 focus:ring-amber-500/50 focus:outline-none transition-all placeholder-slate-600" placeholder="Paste your API Key here">
                </div>
                <div>
                    <label class="block text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Secret Key</label>
                    <input type="password" x-model="apiSecret" class="w-full bg-slate-950 border border-white/10 rounded-xl px-5 py-3 text-white focus:border-amber-500 focus:ring-1 focus:ring-amber-500/50 focus:outline-none transition-all placeholder-slate-600" placeholder="Paste your Secret Key here">
                </div>
            </div>
            
            <div class="flex flex-col md:flex-row justify-between items-center gap-6 pt-6 border-t border-white/5">
                <div class="flex gap-6">
                    <button @click="loadDemoData()" class="text-sm text-slate-400 hover:text-white font-medium transition-colors">Try Demo Mode</button>
                    <button x-show="hasKeys && !showDemo" @click="clearKeys()" class="text-sm text-rose-400 hover:text-rose-300 font-medium transition-colors">Clear Saved Keys</button>
                </div>
                <div class="flex gap-4 w-full md:w-auto">
                    <button x-show="hasKeys" @click="showSettings = false" class="flex-1 md:flex-none px-6 py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-bold transition-all">Cancel</button>
                    <button @click="saveKeys()" class="flex-1 md:flex-none px-8 py-3 bg-gradient-to-r from-amber-500 to-yellow-600 hover:from-amber-400 hover:to-yellow-500 text-black rounded-xl font-bold shadow-lg shadow-amber-900/20 transition-all transform hover:scale-[1.02]">Connect</button>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div x-show="error" x-cloak class="mb-6 p-4 bg-red-900/50 border border-red-700 rounded text-red-200 flex items-start gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div>
                <p class="font-bold">Error Fetching Data</p>
                <p x-text="error" class="text-sm mt-1"></p>
            </div>
        </div>

        <!-- Demo Mode Banner -->
        <div x-show="showDemo" x-transition class="mb-6 p-3 bg-blue-600/20 border border-blue-500/50 rounded flex justify-between items-center">
            <div class="flex items-center gap-2 text-blue-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="font-medium">Demo Mode Active - Displaying simulated data</span>
            </div>
            <button @click="clearKeys()" class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded transition">Exit Demo</button>
        </div>

        <!-- Dashboard -->
        <div x-show="hasKeys && !showSettings" x-transition>
            <!-- Top Section: Balance & Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- Balance Card -->
                <div class="p-8 bg-slate-900/80 backdrop-blur-md rounded-3xl border border-white/10 shadow-2xl flex flex-col justify-between relative overflow-hidden group hover:border-amber-500/30 transition-all duration-500">
                    <div class="absolute inset-0 bg-gradient-to-br from-amber-500/5 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-700"></div>
                    <div class="relative z-10">
                        <div class="flex justify-between items-start">
                             <div class="w-full">
                                <div class="flex justify-between items-center mb-2">
                                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest">Total Balance</p>
                                    <span x-show="wsConnected" class="px-2 py-0.5 rounded-full bg-emerald-500/10 text-emerald-400 text-[10px] font-bold border border-emerald-500/20 flex items-center gap-1.5 animate-pulse">
                                        <span class="block w-1.5 h-1.5 rounded-full bg-emerald-400"></span> LIVE
                                    </span>
                                </div>
                                <h2 class="text-4xl md:text-5xl font-black text-white tracking-tight flex items-baseline gap-1">
                                    <span class="text-slate-500 text-2xl">$</span><span x-text="formatMoney(totalBalanceUSDT)">0.00</span>
                                </h2>
                                <div class="mt-6 pt-6 border-t border-white/5 flex justify-between items-center">
                                    <div>
                                        <span class="text-slate-500 text-xs font-bold uppercase block mb-1">24h Change</span>
                                        <span class="font-bold text-lg block" :class="dailyPnL >= 0 ? 'text-emerald-400' : 'text-rose-400'" x-text="(dailyPnL >= 0 ? '+' : '') + '$' + formatMoney(dailyPnL)"></span>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-slate-500 text-xs font-bold uppercase block mb-1">Performance</span>
                                        <span class="text-sm font-bold px-2 py-1 rounded bg-slate-800 border border-white/5" :class="dailyPnL >= 0 ? 'text-emerald-400' : 'text-rose-400'" x-text="(dailyPnL >= 0 ? '▲' : '▼') + ' ' + Math.abs((dailyPnL / (totalBalanceUSDT - dailyPnL)) * 100).toFixed(2) + '%'"></span>
                                    </div>
                                </div>
                             </div>
                        </div>
                        
                        <div class="mt-6">
                             <div class="flex items-center gap-4 p-4 bg-slate-950/50 rounded-2xl border border-white/5 hover:bg-slate-950 transition-colors" x-show="assets.length > 0">
                                 <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-amber-400 to-yellow-600 text-black flex items-center justify-center font-bold text-xl shadow-lg shadow-amber-500/20" x-text="assets[0]?.asset?.substring(0,1)"></div>
                                 <div>
                                     <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Top Holding</p>
                                     <div class="font-bold text-white text-lg" x-text="assets[0]?.asset"></div>
                                 </div>
                                 <div class="ml-auto text-right">
                                     <div class="text-sm font-bold text-slate-300" x-text="'$' + formatMoney(assets[0]?.valueUSDT)"></div>
                                     <div class="text-xs font-medium text-amber-500" x-text="((assets[0]?.valueUSDT / totalBalanceUSDT) * 100).toFixed(1) + '%'"></div>
                                 </div>
                             </div>
                        </div>
                    </div>
                    
                    <!-- Decorative BG -->
                    <div class="absolute -top-20 -right-20 w-60 h-60 bg-amber-500/10 rounded-full blur-3xl pointer-events-none"></div>
                </div>

                <!-- Allocation Chart -->
                <div class="p-8 bg-slate-900/80 backdrop-blur-md rounded-3xl border border-white/10 shadow-2xl flex flex-col relative" style="min-height: 380px;">
                    <h3 class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-6">Portfolio Allocation</h3>
                    <div class="flex-1 relative flex items-center justify-center">
                        <div class="absolute inset-0 flex items-center justify-center" x-show="assets.length === 0">
                            <p class="text-slate-600 text-sm font-medium">No assets to display</p>
                        </div>
                        <canvas id="allocationChart"></canvas>
                    </div>
                </div>

                <!-- Price History Chart (Improved) -->
                <div class="p-8 bg-slate-900/80 backdrop-blur-md rounded-3xl border border-white/10 shadow-2xl flex flex-col" style="height: 380px;">
                    <div class="flex justify-between items-start mb-6 flex-shrink-0">
                        <div>
                             <h3 class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-1">Price Trend (48h)</h3>
                             <div class="flex items-baseline gap-3" x-show="selectedAsset && selectedAsset.asset">
                                 <span class="text-3xl font-black text-white" x-text="selectedAsset.asset"></span>
                                 <span class="text-xl font-medium text-slate-400" x-text="'$' + formatMoney(selectedAsset.price)"></span>
                             </div>
                             <p x-show="!selectedAsset" class="text-slate-500 font-bold text-lg mt-1 italic">Select an Asset</p>
                        </div>
                        <div x-show="selectedAsset && selectedAsset.asset !== 'USDT'" class="text-right">
                             <span class="text-[10px] font-bold bg-slate-800 px-3 py-1.5 rounded-lg text-slate-400 border border-white/5 uppercase tracking-wide">1H Interval</span>
                        </div>
                    </div>
                    
                    <div class="flex-1 relative w-full min-h-0 bg-slate-950/30 rounded-2xl border border-white/5 overflow-hidden">
                         <div class="absolute inset-0 flex flex-col items-center justify-center text-center p-4 z-10 pointer-events-none" x-show="!selectedAsset || selectedAsset.asset === 'USDT'">
                            <div class="text-slate-500">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto mb-3 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                </svg>
                                <p x-show="!selectedAsset" class="text-sm font-medium">Click an asset in the table below<br>to view its chart.</p>
                                <p x-show="selectedAsset && selectedAsset.asset === 'USDT'" class="text-sm font-medium">USDT is a stablecoin.<br>No price trend available.</p>
                            </div>
                        </div>
                        <div class="absolute inset-0">
                            <canvas id="historyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assets Table -->
            <div class="bg-slate-900/80 backdrop-blur-md rounded-3xl border border-white/10 overflow-hidden shadow-2xl">
                <div class="p-8 border-b border-white/5 flex flex-col md:flex-row justify-between items-center gap-4">
                    <h3 class="text-xl font-bold text-white tracking-tight">Your Assets</h3>
                    <div class="flex items-center gap-6">
                        <label class="flex items-center gap-3 cursor-pointer text-sm text-slate-400 hover:text-white select-none transition-colors">
                            <div class="relative">
                                <input type="checkbox" x-model="hideDust" class="sr-only peer">
                                <div class="w-9 h-5 bg-slate-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-amber-500/50 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-amber-500"></div>
                            </div>
                            <span class="font-medium">Hide Dust (< $1)</span>
                        </label>
                        <div class="text-sm text-slate-500 font-medium bg-slate-950/50 px-3 py-1 rounded-lg border border-white/5">
                             <span x-text="assets.filter(a => !hideDust || a.valueUSDT >= 1).length"></span> shown
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-950/50 text-slate-500 text-xs font-bold uppercase tracking-widest border-b border-white/5">
                                <th class="p-5 pl-8">Asset</th>
                                <th class="p-5 text-right hidden md:table-cell">Total</th>
                                <th class="p-5 text-right">Price (USDT)</th>
                                <th class="p-5 text-right">24h Change</th>
                                <th class="p-5 pr-8 text-right">Value (USDT)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5">
                            <template x-for="asset in assets" :key="asset.asset">
                                <tr x-show="!hideDust || asset.valueUSDT >= 1"
                                    class="hover:bg-white/5 transition duration-200 cursor-pointer group" 
                                    :class="{'bg-amber-500/10 hover:bg-amber-500/20': selectedAsset && selectedAsset.asset === asset.asset}"
                                    @click="selectAsset(asset)">
                                    <td class="p-5 pl-8">
                                        <div class="flex items-center gap-4">
                                            <div class="w-10 h-10 rounded-xl bg-slate-800 text-amber-500 flex items-center justify-center font-bold text-sm shadow-inner group-hover:scale-110 group-hover:bg-amber-500 group-hover:text-black transition-all duration-300" 
                                                 :class="{'bg-amber-500 text-black shadow-lg shadow-amber-500/20': selectedAsset && selectedAsset.asset === asset.asset}"
                                                 x-text="asset.asset.substring(0,1)"></div>
                                            <div>
                                                <div class="font-bold text-white text-base" x-text="asset.asset"></div>
                                                <div class="text-xs text-slate-500 font-medium md:hidden mt-0.5" x-text="formatNumber(asset.total)"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="p-5 text-right font-medium text-slate-300 hidden md:table-cell" x-text="formatNumber(asset.total)"></td>
                                    <td class="p-5 text-right text-slate-400 font-medium transition-colors duration-300" :class="{'text-amber-400 font-bold': selectedAsset && selectedAsset.asset === asset.asset}" x-text="asset.price ? '$' + formatMoney(asset.price) : '-'"></td>
                                    <td class="p-5 text-right font-bold">
                                        <span class="px-2.5 py-1 rounded-lg text-xs border"
                                              :class="asset.change24h >= 0 ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : 'bg-rose-500/10 text-rose-400 border-rose-500/20'"
                                              x-text="asset.change24h ? (asset.change24h > 0 ? '+' : '') + asset.change24h + '%' : '-'">
                                        </span>
                                    </td>
                                    <td class="p-5 pr-8 text-right font-bold text-white tracking-tight" x-text="asset.valueUSDT ? '$' + formatMoney(asset.valueUSDT) : '$0.00'"></td>
                                </tr>
                            </template>
                            <tr x-show="assets.length === 0 && !loading" class="text-center">
                                <td colspan="5" class="p-12 text-slate-500 font-medium">
                                    No assets found or API not connected.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recent Transactions Table -->
            <div class="bg-slate-900/80 backdrop-blur-md rounded-3xl border border-white/10 overflow-hidden shadow-2xl mt-8">
                <div class="p-8 border-b border-white/5 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-white tracking-tight">Recent Trades</h3>
                    <div class="flex items-center gap-4">
                        <span class="text-xs text-amber-500 font-bold animate-pulse" x-show="loadingTrades">Syncing...</span>
                        <div class="text-sm text-slate-500 font-medium bg-slate-950/50 px-3 py-1 rounded-lg border border-white/5">
                            Showing <span x-text="trades.length" class="text-white"></span> records
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-950/50 text-slate-500 text-xs font-bold uppercase tracking-widest border-b border-white/5">
                                <th class="p-5 pl-8">Date</th>
                                <th class="p-5">Pair</th>
                                <th class="p-5">Side</th>
                                <th class="p-5 text-right">Price</th>
                                <th class="p-5 text-right">Quantity</th>
                                <th class="p-5 pr-8 text-right">Total (USDT)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5">
                            <template x-for="trade in trades" :key="trade.id">
                                <tr class="hover:bg-white/5 transition duration-200">
                                    <td class="p-5 pl-8 text-slate-400 whitespace-nowrap text-sm font-medium" x-text="formatDate(trade.time)"></td>
                                    <td class="p-5 font-bold text-white" x-text="trade.symbol"></td>
                                    <td class="p-5">
                                        <span class="px-2.5 py-1 rounded-lg text-xs font-bold border"
                                              :class="trade.isBuyer ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : 'bg-rose-500/10 text-rose-400 border-rose-500/20'"
                                              x-text="trade.isBuyer ? 'BUY' : 'SELL'">
                                        </span>
                                    </td>
                                    <td class="p-5 text-right text-slate-300 font-mono text-sm" x-text="formatNumber(trade.price)"></td>
                                    <td class="p-5 text-right text-slate-300 font-mono text-sm" x-text="formatNumber(trade.qty)"></td>
                                    <td class="p-5 pr-8 text-right font-bold text-slate-200" x-text="formatMoney(trade.quoteQty)"></td>
                                </tr>
                            </template>
                            <tr x-show="trades.length === 0 && !loadingTrades" class="text-center">
                                <td colspan="6" class="p-12 text-slate-500 font-medium">
                                    No recent trades found for your top assets.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Funds History Table -->
            <div class="bg-slate-900/80 backdrop-blur-md rounded-3xl border border-white/10 overflow-hidden shadow-2xl mt-8">
                <div class="p-8 border-b border-white/5 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-white tracking-tight">Funds History</h3>
                    <div class="flex items-center gap-4">
                        <span class="text-xs text-amber-500 font-bold animate-pulse" x-show="loadingHistory">Syncing...</span>
                        <div class="text-sm text-slate-500 font-medium bg-slate-950/50 px-3 py-1 rounded-lg border border-white/5">
                            Showing <span x-text="fundHistory.length" class="text-white"></span> records
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-950/50 text-slate-500 text-xs font-bold uppercase tracking-widest border-b border-white/5">
                                <th class="p-5 pl-8">Date</th>
                                <th class="p-5">Type</th>
                                <th class="p-5">Asset</th>
                                <th class="p-5 text-right">Amount</th>
                                <th class="p-5 text-center">Status</th>
                                <th class="p-5 pr-8 text-right">TxID</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5">
                            <template x-for="item in fundHistory" :key="item.txId">
                                <tr class="hover:bg-white/5 transition duration-200">
                                    <td class="p-5 pl-8 text-slate-400 whitespace-nowrap text-sm font-medium" x-text="formatDate(item.time || item.insertTime)"></td>
                                    <td class="p-5">
                                        <span class="px-2.5 py-1 rounded-lg text-xs font-bold border"
                                              :class="item.type === 'Deposit' ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : 'bg-rose-500/10 text-rose-400 border-rose-500/20'"
                                              x-text="item.type">
                                        </span>
                                    </td>
                                    <td class="p-5 font-bold text-white" x-text="item.coin || item.asset"></td>
                                    <td class="p-5 text-right font-medium text-slate-200" x-text="formatNumber(item.amount)"></td>
                                    <td class="p-5 text-center">
                                         <!-- Status mapping is complex, simple check for common codes -->
                                         <span x-show="item.status === 1 || item.status === 6" class="text-emerald-400 text-xs font-bold flex items-center justify-center gap-1">
                                             <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                                 <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                             </svg>
                                             Completed
                                         </span>
                                         <span x-show="item.status !== 1 && item.status !== 6" class="text-slate-500 text-xs font-mono" x-text="'Status: ' + item.status"></span>
                                    </td>
                                    <td class="p-5 pr-8 text-right text-slate-600 text-xs font-mono" x-text="item.txId ? item.txId.substring(0, 8) + '...' : '-'"></td>
                                </tr>
                            </template>
                            <tr x-show="fundHistory.length === 0 && !loadingHistory" class="text-center">
                                <td colspan="6" class="p-12 text-slate-500 font-medium">
                                    No deposit or withdrawal history found.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-12 text-center text-gray-500 text-sm pb-8">
        <p>&copy; 2023 Binance Portfolio Tracker. Not affiliated with Binance.</p>
        <p class="mt-2 text-xs">Security Note: API Keys are stored locally in your browser's localStorage.</p>
    </footer>

    <script>
        function binanceApp() {
            return {
                apiKey: localStorage.getItem('binance_api_key') || '',
                apiSecret: localStorage.getItem('binance_api_secret') || '',
                showSettings: false,
                hasKeys: false,
                loading: false,
                error: null,
                assets: [],
                trades: [],
                fundHistory: [],
                totalBalanceUSDT: 0,
                dailyPnL: 0,
                hideDust: false,
                showDemo: false,
                chartInstance: null,
                historyChartInstance: null,
                loadingTrades: false,
                loadingHistory: false,
                selectedAsset: null,
                socket: null,
                priceHistory: [],
                wsConnected: false,

                init() {
                    if (this.apiKey && this.apiSecret) {
                        this.hasKeys = true;
                        // Initial fetch if keys exist? Maybe let user trigger or trigger automatically
                        // For now we wait for user or manual trigger, but we could auto-fetch:
                        // this.fetchData();
                    } else {
                        this.showSettings = true;
                    }
                },

                saveKeys() {
                    if (this.apiKey && this.apiSecret) {
                        localStorage.setItem('binance_api_key', this.apiKey);
                        localStorage.setItem('binance_api_secret', this.apiSecret);
                        this.hasKeys = true;
                        this.showSettings = false;
                        this.showDemo = false;
                        this.fetchData();
                    }
                },

                clearKeys() {
                    localStorage.removeItem('binance_api_key');
                    localStorage.removeItem('binance_api_secret');
                    this.apiKey = '';
                    this.apiSecret = '';
                    this.hasKeys = false;
                    this.assets = [];
                    this.trades = [];
                    this.totalBalanceUSDT = 0;
                    this.showSettings = true;
                    this.showDemo = false;
                    if(this.chartInstance) {
                        this.chartInstance.destroy();
                        this.chartInstance = null;
                    }
                },

                loadDemoData() {
                    this.loading = true;
                    this.error = null;
                    this.showSettings = false;
                    this.showDemo = true;
                    
                    setTimeout(() => {
                        this.assets = [
                            { asset: 'BTC', free: '0.45', locked: '0.0', total: 0.45, price: 64200.50, change24h: 2.5, valueUSDT: 28890.22 },
                            { asset: 'ETH', free: '4.2', locked: '1.0', total: 5.2, price: 3450.20, change24h: -1.2, valueUSDT: 17941.04 },
                            { asset: 'BNB', free: '15.5', locked: '5.0', total: 20.5, price: 590.10, change24h: 0.5, valueUSDT: 12097.05 },
                            { asset: 'SOL', free: '150', locked: '0', total: 150, price: 145.50, change24h: 5.8, valueUSDT: 21825.00 },
                            { asset: 'USDT', free: '5400.20', locked: '0', total: 5400.20, price: 1.00, change24h: 0.01, valueUSDT: 5400.20 },
                            { asset: 'DOGE', free: '5.0', locked: '0', total: 5.0, price: 0.12, change24h: -3.5, valueUSDT: 0.60 }, // Dust example
                        ].sort((a, b) => b.valueUSDT - a.valueUSDT);

                        // Calculate Demo PnL
                        this.dailyPnL = this.assets.reduce((sum, asset) => {
                             const prevValue = asset.valueUSDT / (1 + (asset.change24h / 100));
                             return sum + (asset.valueUSDT - prevValue);
                        }, 0);

                        // Demo Trades
                        this.trades = [
                            { id: 1, time: Date.now() - 10000000, symbol: 'BTCUSDT', isBuyer: true, price: 63500, qty: 0.1, quoteQty: 6350 },
                            { id: 2, time: Date.now() - 50000000, symbol: 'ETHUSDT', isBuyer: false, price: 3500, qty: 1.5, quoteQty: 5250 },
                            { id: 3, time: Date.now() - 120000000, symbol: 'SOLUSDT', isBuyer: true, price: 140, qty: 50, quoteQty: 7000 },
                        ];

                        // Demo Fund History
                        this.fundHistory = [
                            { insertTime: Date.now() - 86400000 * 2, amount: 0.5, asset: 'BTC', type: 'Deposit', status: 1, txId: '1a2b3c...' },
                            { insertTime: Date.now() - 86400000 * 5, amount: 1000, asset: 'USDT', type: 'Withdraw', status: 6, txId: '4d5e6f...' },
                            { insertTime: Date.now() - 86400000 * 10, amount: 5.0, asset: 'ETH', type: 'Deposit', status: 1, txId: '7g8h9i...' }
                        ];
                        
                        this.totalBalanceUSDT = this.assets.reduce((sum, asset) => sum + asset.valueUSDT, 0);
                        this.loading = false;
                        this.hasKeys = true; 
                        
                        this.selectAsset(this.assets[0]);
                        this.renderChart();
                    }, 800);
                },

                formatNumber(num) {
                    return parseFloat(num).toLocaleString('en-US', { maximumFractionDigits: 8 });
                },

                formatMoney(num) {
                    return parseFloat(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                },

                formatDate(timestamp) {
                    return new Date(timestamp).toLocaleString();
                },

                renderChart() {
                    const ctx = document.getElementById('allocationChart').getContext('2d');
                    
                    if (this.chartInstance) {
                        this.chartInstance.destroy();
                    }

                    const topAssets = this.assets.slice(0, 5);
                    const otherAssets = this.assets.slice(5);
                    const otherValue = otherAssets.reduce((sum, a) => sum + a.valueUSDT, 0);

                    const labels = topAssets.map(a => a.asset);
                    const data = topAssets.map(a => a.valueUSDT);
                    
                    if (otherValue > 0) {
                        labels.push('Others');
                        data.push(otherValue);
                    }

                    const colors = [
                        '#f59e0b', // Amber 500
                        '#334155', // Slate 700
                        '#10b981', // Emerald 500
                        '#6366f1', // Indigo 500
                        '#f43f5e', // Rose 500
                        '#94a3b8'  // Slate 400
                    ];

                    this.chartInstance = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: colors,
                                borderColor: '#0f172a', // Slate 900
                                borderWidth: 4,
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false 
                                }
                            },
                            cutout: '60%'
                        }
                    });
                },

                renderHistoryChart() {
                    const ctx = document.getElementById('historyChart').getContext('2d');
                    
                    if (this.historyChartInstance) {
                        this.historyChartInstance.destroy();
                    }

                    const times = this.priceHistory.map(h => new Date(h.time).toLocaleDateString());
                    const prices = this.priceHistory.map(h => h.close);
                    
                    const isPositive = prices[prices.length - 1] >= prices[0];
                    const color = isPositive ? '#10B981' : '#EF4444';
                    const bgGradient = ctx.createLinearGradient(0, 0, 0, 400);
                    bgGradient.addColorStop(0, isPositive ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)');
                    bgGradient.addColorStop(1, 'rgba(0, 0, 0, 0)');

                    this.historyChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: times,
                            datasets: [{
                                label: 'Price (USDT)',
                                data: prices,
                                borderColor: color,
                                backgroundColor: bgGradient,
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0,
                                pointHoverRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: (context) => '$' + context.parsed.y.toLocaleString()
                                    }
                                }
                            },
                            scales: {
                                x: { display: false },
                                y: {
                                    display: true,
                                    grid: { color: '#374151' },
                                    ticks: { color: '#9CA3AF' }
                                }
                            }
                        }
                    });
                },

                async selectAsset(asset) {
                    this.selectedAsset = asset;
                    if (asset.asset === 'USDT') return; 
                    
                    const symbol = asset.asset + 'USDT';
                    
                    if (this.showDemo) {
                        let price = asset.price;
                        this.priceHistory = Array.from({length: 24}, (_, i) => {
                            price = price * (1 + (Math.random() - 0.5) * 0.05);
                            return { time: Date.now() - (23 - i) * 3600000, close: price };
                        });
                        this.$nextTick(() => this.renderHistoryChart());
                        return;
                    }

                    try {
                        const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1h&limit=48`);
                        const data = await res.json();
                        this.priceHistory = data.map(k => ({
                            time: k[0],
                            close: parseFloat(k[4])
                        }));
                        
                        this.$nextTick(() => this.renderHistoryChart());
                    } catch (e) {
                        console.error('Failed to load history', e);
                    }
                },

                connectWebSocket() {
                    if (this.wsConnected) return;

                    const assetsToWatch = this.assets
                        .filter(a => a.asset !== 'USDT')
                        .map(a => a.asset.toLowerCase() + 'usdt@miniTicker');
                    
                    if (assetsToWatch.length === 0) return;

                    const streamName = assetsToWatch.join('/');
                    const wsUrl = `wss://stream.binance.com:9443/ws/${streamName}`;

                    this.socket = new WebSocket(wsUrl);

                    this.socket.onopen = () => {
                        this.wsConnected = true;
                        console.log('WebSocket Connected');
                    };

                    this.socket.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        const symbol = data.s.replace('USDT', '');
                        const assetIdx = this.assets.findIndex(a => a.asset === symbol);
                        
                        if (assetIdx !== -1) {
                            const newPrice = parseFloat(data.c);
                            const oldPrice = this.assets[assetIdx].price;
                            
                            if (newPrice !== oldPrice) {
                                this.assets[assetIdx].price = newPrice;
                                const oldVal = this.assets[assetIdx].valueUSDT;
                                this.assets[assetIdx].valueUSDT = this.assets[assetIdx].total * newPrice;
                                this.totalBalanceUSDT = this.totalBalanceUSDT - oldVal + this.assets[assetIdx].valueUSDT;
                            }
                        }
                    };

                    this.socket.onerror = (err) => {
                        console.error('WebSocket Error', err);
                        this.wsConnected = false;
                    };

                    this.socket.onclose = () => {
                        this.wsConnected = false;
                        if (this.hasKeys && !this.showDemo) {
                            setTimeout(() => this.connectWebSocket(), 5000);
                        }
                    };
                },

                async fetchTransactions(serverTime) {
                    this.loadingTrades = true;
                    this.trades = [];
                    
                    // We only fetch trades for the top 5 assets by value to avoid rate limits
                    const assetsToFetch = this.assets.slice(0, 5).filter(a => a.asset !== 'USDT');
                    const tradePromises = [];

                    for (const asset of assetsToFetch) {
                        const symbol = asset.asset + 'USDT'; // Assumption: most trades against USDT
                        const params = `timestamp=${serverTime}&symbol=${symbol}&limit=5`;
                        const signature = CryptoJS.HmacSHA256(params, this.apiSecret).toString();
                        
                        tradePromises.push(
                            fetch(`https://api.binance.com/api/v3/myTrades?${params}&signature=${signature}`, {
                                headers: { 'X-MBX-APIKEY': this.apiKey }
                            })
                            .then(res => res.ok ? res.json() : [])
                            .catch(() => []) // Ignore errors for specific pairs
                        );
                    }

                    try {
                        const results = await Promise.all(tradePromises);
                        let allTrades = results.flat();
                        
                        // Sort by time descending
                        allTrades.sort((a, b) => b.time - a.time);
                        
                        // Take top 20 recent trades
                        this.trades = allTrades.slice(0, 20);

                    } catch (e) {
                        console.error("Error fetching trades:", e);
                    } finally {
                        this.loadingTrades = false;
                    }
                },

                async fetchFundHistory(serverTime) {
                    this.loadingHistory = true;
                    this.fundHistory = [];
                    const params = `timestamp=${serverTime}`;
                    const signature = CryptoJS.HmacSHA256(params, this.apiSecret).toString();
                    const qs = `${params}&signature=${signature}`;
                    
                    try {
                        const [depRes, withRes] = await Promise.all([
                            fetch(`https://api.binance.com/sapi/v1/capital/deposit/hisrec?${qs}`, { headers: { 'X-MBX-APIKEY': this.apiKey } }),
                            fetch(`https://api.binance.com/sapi/v1/capital/withdraw/history?${qs}`, { headers: { 'X-MBX-APIKEY': this.apiKey } })
                        ]);

                        const deposits = depRes.ok ? await depRes.json() : [];
                        const withdrawals = withRes.ok ? await withRes.json() : [];

                        // Normalize Data
                        const depList = (Array.isArray(deposits) ? deposits : []).map(d => ({
                            ...d,
                            type: 'Deposit',
                            time: d.insertTime
                        }));
                        
                        const withList = (Array.isArray(withdrawals) ? withdrawals : []).map(w => ({
                            ...w,
                            type: 'Withdraw',
                            time: w.applyTime || w.insertTime // Withdrawals might use applyTime
                        }));

                        this.fundHistory = [...depList, ...withList].sort((a, b) => b.time - a.time).slice(0, 50);

                    } catch (e) {
                        console.error("Error fetching fund history:", e);
                    } finally {
                        this.loadingHistory = false;
                    }
                },

                async fetchData() {
                    if (this.showDemo) {
                        this.loadDemoData();
                        return;
                    }

                    if (!this.apiKey || !this.apiSecret) {
                        this.error = "Please configure your API keys first.";
                        this.showSettings = true;
                        return;
                    }

                    this.loading = true;
                    this.error = null;
                    this.assets = [];
                    this.totalBalanceUSDT = 0;
                    this.dailyPnL = 0;

                    try {
                        // 1. Get Server Time
                        const timeRes = await fetch('https://api.binance.com/api/v3/time');
                        if (!timeRes.ok) throw new Error("Failed to fetch server time. Check CORS/Network.");
                        const timeData = await timeRes.json();
                        const serverTime = timeData.serverTime;
                        
                        const timestamp = serverTime;
                        const params = `timestamp=${timestamp}`;
                        
                        // HMAC SHA256 Signature
                        const signature = CryptoJS.HmacSHA256(params, this.apiSecret).toString();
                        const queryString = `${params}&signature=${signature}`;
                        
                        // 3. Fetch Account Info
                        const accountRes = await fetch(`https://api.binance.com/api/v3/account?${queryString}`, {
                            headers: { 'X-MBX-APIKEY': this.apiKey }
                        });

                        if (!accountRes.ok) {
                            const errData = await accountRes.json().catch(() => ({}));
                            throw new Error(errData.msg || `API Error: ${accountRes.status} ${accountRes.statusText}`);
                        }

                        const accountData = await accountRes.json();
                        
                        // Filter non-zero balances
                        const nonZeroAssets = accountData.balances.filter(b => parseFloat(b.free) > 0 || parseFloat(b.locked) > 0);

                        // 4. Fetch 24hr Ticker Statistics (Better than just price)
                        // This gives us price AND 24h change %
                        const tickerRes = await fetch('https://api.binance.com/api/v3/ticker/24hr');
                        const tickerData = await tickerRes.json();
                        
                        // Create price & change map
                        const marketMap = {};
                        tickerData.forEach(t => {
                            marketMap[t.symbol] = {
                                price: parseFloat(t.lastPrice),
                                change: parseFloat(t.priceChangePercent)
                            };
                        });

                        // 5. Calculate Values
                        this.assets = nonZeroAssets.map(asset => {
                            const total = parseFloat(asset.free) + parseFloat(asset.locked);
                            let price = 0;
                            let change24h = 0;
                            let symbol = asset.asset;
                            
                            if (symbol === 'USDT') {
                                price = 1;
                                change24h = 0;
                            } else {
                                // Direct pair
                                if (marketMap[`${symbol}USDT`]) {
                                    price = marketMap[`${symbol}USDT`].price;
                                    change24h = marketMap[`${symbol}USDT`].change;
                                } 
                                // USDC pair
                                else if (marketMap[`${symbol}USDC`]) {
                                     price = marketMap[`${symbol}USDC`].price; 
                                     change24h = marketMap[`${symbol}USDC`].change;
                                }
                                // BTC pair
                                else if (marketMap[`${symbol}BTC`] && marketMap['BTCUSDT']) {
                                    price = marketMap[`${symbol}BTC`].price * marketMap['BTCUSDT'].price;
                                    change24h = marketMap[`${symbol}BTC`].change; // Approx change vs BTC
                                }
                            }

                            const valueUSDT = total * price;
                            this.totalBalanceUSDT += valueUSDT;

                            // Calculate implied previous value for PnL
                            // prev = current / (1 + change/100)
                            const prevValue = valueUSDT / (1 + (change24h / 100));
                            this.dailyPnL += (valueUSDT - prevValue);

                            return {
                                asset: asset.asset,
                                free: asset.free,
                                locked: asset.locked,
                                total: total,
                                price: price,
                                change24h: change24h,
                                valueUSDT: valueUSDT
                            };
                        }).sort((a, b) => b.valueUSDT - a.valueUSDT);

                        // Render Chart
                        this.$nextTick(() => {
                             this.renderChart();
                        });

                        // Fetch Transactions
                        this.fetchTransactions(serverTime);
                        this.fetchFundHistory(serverTime);
                        
                        // Connect Realtime
                        this.connectWebSocket();
                        
                        // Select first asset
                        if(this.assets.length > 0) {
                            this.selectAsset(this.assets[0]);
                        }

                    } catch (e) {
                        console.error(e);
                        this.error = e.message;
                        if (e.message.includes('Failed to fetch') || e.message.includes('NetworkError')) {
                            this.error += " (Likely a CORS issue. Please use a browser extension to allow CORS or run a local proxy.)";
                        }
                    } finally {
                        this.loading = false;
                    }
                }
            }
        }
    </script>
</body>
</html>